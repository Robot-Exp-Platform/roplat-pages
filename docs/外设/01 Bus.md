# 外设篇 - 总线

![图 1](images/有外设内核.png)  

总线实际上可以被理解为一个相互保证协议，通过总线的信息都应当有相同的格式。

在机器人操作系统中，总线实际上还多了一层额外的含义，总线将作为一种安全性的把关，具体阐述为：

1. 向外设许诺一定提供**合法的**、**安全的**指令
2. 向内核提供一定**及时**反馈的外设

必须要说明的一点是厂商提供的指令集中有大量无用的指令，也有大量无法保证安全的指令。不安全的指令通常会导致外设的不安全行为，轻则导致外设的损坏，重则导致外设周围的人员损坏。

**简单来说，总线需要对指令进行审查和过滤，同时监控外设状态，及时发现外设的异常行为。**

有时，我们希望发送指令时仿真器能和真实机器人一样收到指令，但是只使用真实机器人返回的状态，这就是总线发力的时候了。

## 实现

总线节点接受信息采用多生产者单消费者结构，从每个任务末端获取指令，然后通过总线发送给外设，外设返回的状态也通过总线返回给任务末端。

总线是全局节点的一种。

总线执行逻辑中，需要完成以下部分：

1. 等待指令
2. 收到新指令，检查合法性，根据指令标签发给对应的外设（指令类型检查交给泛型的静态检查）

信号不应该在总线上滞留太多时间.jpg

完成本模块需要做的事情：

1. 修改 Node 实现，为每个 Node 节点增加一个生产者，在 Exp 中新建节点时为每个节点分配一个生产者对象
1. 在每个任务节点中检查 is_end 属性，如果为假，则向 output 发送指令， 如果为真，则使用任务生产者发送指令
2. 总线节点中掌握所有外设，同时保留消费者对象。
3. 实现总线节点逻辑